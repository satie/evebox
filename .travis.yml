sudo: false
services:
- docker
env:
  global:
  - GOPATH=~/gopath
  - PATH=${GOPATH}/bin:$PATH
  - NODE_VERSION="10.13.0"
  - RUBY_VERSION=2.1.1
  - GO111MODULE=on
  - DOCKER_OWNER=satie
  - DOCKER_IMAGE_NAME=evebox
  - DOCKER_REPO=${DOCKER_OWNER}/${DOCKER_IMAGE_NAME}
  - secure: wMMplEXcdWKUq+2x5+prA2TTQJjKKx6aQKIWD+dAKYi9Pc/8Fa0f3DuF1z79idmyJ3Lue/2aVrCf66sLbxMxtmNGxK1j1GJDFmFLCi27OPITInDbEE5YZ9ynSRKds9shw+zx1+UiygA9ax4vcw5PkYeSxnoa4C8KL9ZQx8wO7ZrMRLReFhtC3c5Y/7C4rpx19bPKGenjdoVeX+1/LCvUw6pQYqmyNuztfBJtIGXY+pBoKjJBqr/kr5H+3+vbyJQB+6x8jHIlk14NLjVECUo+6CmX+3/xEdAlo4+IhAuwIucV5Al/7D1pOMldi0+nDjcNlR1IZonj58/vO/XcCpGkIyYKcH1wniGMushXJwbr1o3NR8bndKKzfw9Z+ma2jbTycLAo0xOVgRpdYeI6QaDijgs1f8pKA6tFjhInDrhJORn2kSF1ai6TFFWK0vghqUCQKRK50pf3wMiq3/FDvWWat8k5FD8e2bhSTFu7vxH7j8QNwixOa6kTE5kaTP9QhnZNU+7TUOtO/W6tJS5uW768RXjiumgpt/5qKykDv8D4le6vXeb4q2KPnO0tRRvARHwLV4l/xcjFhHdmBg29lXsfxEwHT5QqNwAd+xXsx4E9rA/y5JfOWav0SYCdsNRYT6rXf2yt7Jp4jqMyKWY73qhHnYZyVZJsg477KaBwt7R6xDg=
  - secure: AIb7B4UJvFjm7mQTfh0fayVGple3/IA596UYyhQ2uKRueG3VAa1Fy7Nqjf8JA3/I0xsvCmkDWZs2DBh6R4zr7b5PtWFVsH/OXX0rdPDXPLd30P9EsfTn+a9/RJxusbHzoGvBtd/Rsn6EfW0JApp/D5VvBYeyIhSC8IXH+lcOr4X7/Oq/Iu6zP1cq/EqndhFk1qacGaLKPDOv+JIMO6U0oYXb0l9loTHCVugZJkqvi3yUJlcrg7kb6n1WAzWYvP175CCcC1za4Y+wkzGH1PaDqLEHRCemXqVLovcCul1zl45w8a4pdbqFOOmigNO6/ZH8TT0i4ShqpCE+3+KjDyrpX7RpazwMkBZW1/hworT12ZYz5kR5Nq1wAZQl2v8xzs+vNYe5T5WQflM1+Q9DQ4PCDU7KrGodYrdWypWmRG+Vnea3ra0lgVAgGbQkFaVIdD5vqN3yIR8GHmwJMBT0fScr5BMfCyWX3+bMM+yR6MzhtHxYTYrAcP83JKovXKmivX/70u3dE6jZr7QCcjK2j3jsm7dC3DvjA4Q4WLKxFgOUSV1kv6hrjGhhjWexRxmohFgSeBoRmhTduFpHt1qaS/FixCWzsLM6UGxP1SJY+nA9cgAl0qYoeIhiKHe68pAd22ZWqDeXTU2j21UDZBsJwmeYv2lKeMtECKUeSgN5y/xmqbM=
matrix:
  allow_failures:
  - os: osx
  include:
  - os: linux
    addons:
      apt:
        packages:
        - rpm
        - gcc-mingw-w64
    language: go
    go: '1.11'
  - os: osx
    osx_image: xcode8.3
    language: go
    go: '1.11'
before_install:
- echo "${DOCKER_USERNAME} - "
- echo $DOCKER_USERNAME
- nvm install ${NODE_VERSION}
- nvm use ${NODE_VERSION}
script:
- |
  make install-deps || exit 1
  make dist || exit 1

  # On Linux, make a Windows release as well.
  if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
    GOOS=windows CC=x86_64-w64-mingw32-gcc make dist || exit 1
  fi

  # Copy just what we want to deploy to S3 into a deploy directory, as
  # the S3 deployment step will copy everything in the directory
  # pointed at.
  mkdir -p deploy
  cp dist/*.zip deploy/

  if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
    rvm install $RUBY_VERSION
    rvm use $RUBY_VERSION
    gem install fpm
    sudo apt-get -y install rpm
    make deb
    make rpm
    cp dist/*.deb deploy/
    cp dist/*.rpm deploy/
  fi
after_success:
- echo "${DOCKER_USERNAME} - "
- echo $DOCKER_USERNAME
- docker login -u "${DOCKER_USERNAME}" -p "${DOCKER_PASSWORD}"
- docker build -t ${DOCKER_REPO}:${TRAVIS_COMMIT} ./docker/release-${TRAVIS_BRANCH}
- docker tag ${DOCKER_REPO}:${TRAVIS_COMMIT} ${DOCKER_REPO}:${TRAVIS_BRANCH}
- docker tag ${DOCKER_REPO}:${TRAVIS_COMMIT} ${DOCKER_REPO}:travis-${TRAVIS_BUILD_NUMBER}
- docker push ${DOCKER_REPO}
deploy:
- provider: s3
  access_key_id:
    secure: kxjAF09t7HDgwn0q/xsvIqpi0VULwYMetHpEXZ56w2pkmq6e3ReHOwpXpbsMHg2FSbkf5Hblb1st9WcdmVpySO/Cj6NKahmZSaD+DA5ckB6e5N/6Y/7qmSXRxw/dFFVbjdRoqZ4WnzPQ4s22AjJGUgvrNk3PtaM/FnG0I+Jb3aVA0VWBvMnP+cBaq7aM7RT6+/TZXdVgT9Y2xMpyjD6kfur7njg1s0023MgiIdGafBH7vdbtr7N/YEDR4Z8oVXC3yZBbAnADn19f6Rl220F1JXsRCY25j55aXBpdbNu9L+W+43rFb+tDl/t7DyalgsZE5oB1pzWjh2uVShJfV+pvGoTL7sgZcpVxqU6dCHCTm9I7Tb6UtJpDECIuiyq/gGOPEbyHuUPZ3E3z9UO960Hnbq7jFUgBg0P/+AF5vzI/DPksNiHMahkmgJtBk/Wbanb28I/gKO4Nf5INn5yUqUXo+eUx1kmuFWBNcVqH/DCV6glCeUwsmS5piMXipemBEwLlSPr9An7exh/2TEcXU62Dcfd/vVWLji6n1/NezYW/Hr8kjWqgFMyp5JbIwza+g05xlAXD2afu1m94PAEyI6u7DN5lbh05PWoKYfNKHmx9Hka0GltAbJs/jsa1rvIjFn+XVE4mQeOHmLRI4pIl3zGpR4FCUCj510fnQaoUR1l6U9U=
  secret_access_key:
    secure: iLGTpFwLHTfDZaR6jlSovWK3S8f+QzPX0Czez57SZAN8CMqqPljSsHSGSavBU4v3YamMhOwCNka1p99L3q9pzr2sEKDYBfsAIB0HMi8820iF4B+6qYpnhOKrSwxs62/+Nujqfqe0Nyn+RVGHdA2yDW6gHNzIe18ZB8gvCkesQQxszQZLilT16jDdcLmWFbh4wGHnULfuvtdz1sG79DvYLexu5EZVMwuqPHnCE0lC2Uv/VJTHmqTRyGV3drN/zFP6ubtfQUkgcR9E4C05TC0CkKUQtXuNzv9oE6aPkrQYvxQZKbhsVxBK8BZQ6K9pn/BKOBU/PinD86pclRVHGU2m+Qb4Ik77IVUh5V/0CW168EdiAMQhdc7bdytYo7cn2pNjxztQhT0CDPYH8vYniR0bEFNcQEbFNwlXz/StyqsT5vu035a5Qo9NQy/kMtn6KxTfGyvinvZzkGkp9T+85HSL6BAaBWYYgmRpgKniML/aN0L3aJPegABovnt1EeC9sFoq8Kc8omZF4XjxNxlolsq1tUWnOAVyaWpth8xz6iS24ixbWyIRvws2rkNaOPF9c6frnIdogK7Oo4bbEPJVa/4aufX+3URG1gKFbUokC29iDVRybkwIvqU5GBtMU18gXM8pRIlc45too3Zh4l3fvpVnM4YJCsyv0wKCuSLjzcqKoAw=
  bucket: evebox-ci.satie.io
  skip_cleanup: true
  region: us-east-1
  local_dir: deploy
  on:
    repo: satie/evebox
    branch: master
  acl: public_read
  upload-dir: master
- provider: s3
  access_key_id:
    secure: kxjAF09t7HDgwn0q/xsvIqpi0VULwYMetHpEXZ56w2pkmq6e3ReHOwpXpbsMHg2FSbkf5Hblb1st9WcdmVpySO/Cj6NKahmZSaD+DA5ckB6e5N/6Y/7qmSXRxw/dFFVbjdRoqZ4WnzPQ4s22AjJGUgvrNk3PtaM/FnG0I+Jb3aVA0VWBvMnP+cBaq7aM7RT6+/TZXdVgT9Y2xMpyjD6kfur7njg1s0023MgiIdGafBH7vdbtr7N/YEDR4Z8oVXC3yZBbAnADn19f6Rl220F1JXsRCY25j55aXBpdbNu9L+W+43rFb+tDl/t7DyalgsZE5oB1pzWjh2uVShJfV+pvGoTL7sgZcpVxqU6dCHCTm9I7Tb6UtJpDECIuiyq/gGOPEbyHuUPZ3E3z9UO960Hnbq7jFUgBg0P/+AF5vzI/DPksNiHMahkmgJtBk/Wbanb28I/gKO4Nf5INn5yUqUXo+eUx1kmuFWBNcVqH/DCV6glCeUwsmS5piMXipemBEwLlSPr9An7exh/2TEcXU62Dcfd/vVWLji6n1/NezYW/Hr8kjWqgFMyp5JbIwza+g05xlAXD2afu1m94PAEyI6u7DN5lbh05PWoKYfNKHmx9Hka0GltAbJs/jsa1rvIjFn+XVE4mQeOHmLRI4pIl3zGpR4FCUCj510fnQaoUR1l6U9U=
  secret_access_key:
    secure: iLGTpFwLHTfDZaR6jlSovWK3S8f+QzPX0Czez57SZAN8CMqqPljSsHSGSavBU4v3YamMhOwCNka1p99L3q9pzr2sEKDYBfsAIB0HMi8820iF4B+6qYpnhOKrSwxs62/+Nujqfqe0Nyn+RVGHdA2yDW6gHNzIe18ZB8gvCkesQQxszQZLilT16jDdcLmWFbh4wGHnULfuvtdz1sG79DvYLexu5EZVMwuqPHnCE0lC2Uv/VJTHmqTRyGV3drN/zFP6ubtfQUkgcR9E4C05TC0CkKUQtXuNzv9oE6aPkrQYvxQZKbhsVxBK8BZQ6K9pn/BKOBU/PinD86pclRVHGU2m+Qb4Ik77IVUh5V/0CW168EdiAMQhdc7bdytYo7cn2pNjxztQhT0CDPYH8vYniR0bEFNcQEbFNwlXz/StyqsT5vu035a5Qo9NQy/kMtn6KxTfGyvinvZzkGkp9T+85HSL6BAaBWYYgmRpgKniML/aN0L3aJPegABovnt1EeC9sFoq8Kc8omZF4XjxNxlolsq1tUWnOAVyaWpth8xz6iS24ixbWyIRvws2rkNaOPF9c6frnIdogK7Oo4bbEPJVa/4aufX+3URG1gKFbUokC29iDVRybkwIvqU5GBtMU18gXM8pRIlc45too3Zh4l3fvpVnM4YJCsyv0wKCuSLjzcqKoAw=
  bucket: evebox-ci.satie.io
  skip_cleanup: true
  region: us-east-1
  local_dir: deploy
  on:
    repo: satie/evebox
    branch: develop
  acl: public_read
  upload-dir: develop
- provider: s3
  access_key_id:
    secure: kxjAF09t7HDgwn0q/xsvIqpi0VULwYMetHpEXZ56w2pkmq6e3ReHOwpXpbsMHg2FSbkf5Hblb1st9WcdmVpySO/Cj6NKahmZSaD+DA5ckB6e5N/6Y/7qmSXRxw/dFFVbjdRoqZ4WnzPQ4s22AjJGUgvrNk3PtaM/FnG0I+Jb3aVA0VWBvMnP+cBaq7aM7RT6+/TZXdVgT9Y2xMpyjD6kfur7njg1s0023MgiIdGafBH7vdbtr7N/YEDR4Z8oVXC3yZBbAnADn19f6Rl220F1JXsRCY25j55aXBpdbNu9L+W+43rFb+tDl/t7DyalgsZE5oB1pzWjh2uVShJfV+pvGoTL7sgZcpVxqU6dCHCTm9I7Tb6UtJpDECIuiyq/gGOPEbyHuUPZ3E3z9UO960Hnbq7jFUgBg0P/+AF5vzI/DPksNiHMahkmgJtBk/Wbanb28I/gKO4Nf5INn5yUqUXo+eUx1kmuFWBNcVqH/DCV6glCeUwsmS5piMXipemBEwLlSPr9An7exh/2TEcXU62Dcfd/vVWLji6n1/NezYW/Hr8kjWqgFMyp5JbIwza+g05xlAXD2afu1m94PAEyI6u7DN5lbh05PWoKYfNKHmx9Hka0GltAbJs/jsa1rvIjFn+XVE4mQeOHmLRI4pIl3zGpR4FCUCj510fnQaoUR1l6U9U=
  secret_access_key:
    secure: iLGTpFwLHTfDZaR6jlSovWK3S8f+QzPX0Czez57SZAN8CMqqPljSsHSGSavBU4v3YamMhOwCNka1p99L3q9pzr2sEKDYBfsAIB0HMi8820iF4B+6qYpnhOKrSwxs62/+Nujqfqe0Nyn+RVGHdA2yDW6gHNzIe18ZB8gvCkesQQxszQZLilT16jDdcLmWFbh4wGHnULfuvtdz1sG79DvYLexu5EZVMwuqPHnCE0lC2Uv/VJTHmqTRyGV3drN/zFP6ubtfQUkgcR9E4C05TC0CkKUQtXuNzv9oE6aPkrQYvxQZKbhsVxBK8BZQ6K9pn/BKOBU/PinD86pclRVHGU2m+Qb4Ik77IVUh5V/0CW168EdiAMQhdc7bdytYo7cn2pNjxztQhT0CDPYH8vYniR0bEFNcQEbFNwlXz/StyqsT5vu035a5Qo9NQy/kMtn6KxTfGyvinvZzkGkp9T+85HSL6BAaBWYYgmRpgKniML/aN0L3aJPegABovnt1EeC9sFoq8Kc8omZF4XjxNxlolsq1tUWnOAVyaWpth8xz6iS24ixbWyIRvws2rkNaOPF9c6frnIdogK7Oo4bbEPJVa/4aufX+3URG1gKFbUokC29iDVRybkwIvqU5GBtMU18gXM8pRIlc45too3Zh4l3fvpVnM4YJCsyv0wKCuSLjzcqKoAw=
  bucket: evebox-ci.satie.io
  skip_cleanup: true
  region: us-east-1
  local_dir: deploy
  on:
    repo: satie/evebox
    branch: release-staging
  acl: public_read
  upload-dir: release-staging
- provider: s3
  access_key_id:
    secure: kxjAF09t7HDgwn0q/xsvIqpi0VULwYMetHpEXZ56w2pkmq6e3ReHOwpXpbsMHg2FSbkf5Hblb1st9WcdmVpySO/Cj6NKahmZSaD+DA5ckB6e5N/6Y/7qmSXRxw/dFFVbjdRoqZ4WnzPQ4s22AjJGUgvrNk3PtaM/FnG0I+Jb3aVA0VWBvMnP+cBaq7aM7RT6+/TZXdVgT9Y2xMpyjD6kfur7njg1s0023MgiIdGafBH7vdbtr7N/YEDR4Z8oVXC3yZBbAnADn19f6Rl220F1JXsRCY25j55aXBpdbNu9L+W+43rFb+tDl/t7DyalgsZE5oB1pzWjh2uVShJfV+pvGoTL7sgZcpVxqU6dCHCTm9I7Tb6UtJpDECIuiyq/gGOPEbyHuUPZ3E3z9UO960Hnbq7jFUgBg0P/+AF5vzI/DPksNiHMahkmgJtBk/Wbanb28I/gKO4Nf5INn5yUqUXo+eUx1kmuFWBNcVqH/DCV6glCeUwsmS5piMXipemBEwLlSPr9An7exh/2TEcXU62Dcfd/vVWLji6n1/NezYW/Hr8kjWqgFMyp5JbIwza+g05xlAXD2afu1m94PAEyI6u7DN5lbh05PWoKYfNKHmx9Hka0GltAbJs/jsa1rvIjFn+XVE4mQeOHmLRI4pIl3zGpR4FCUCj510fnQaoUR1l6U9U=
  secret_access_key:
    secure: iLGTpFwLHTfDZaR6jlSovWK3S8f+QzPX0Czez57SZAN8CMqqPljSsHSGSavBU4v3YamMhOwCNka1p99L3q9pzr2sEKDYBfsAIB0HMi8820iF4B+6qYpnhOKrSwxs62/+Nujqfqe0Nyn+RVGHdA2yDW6gHNzIe18ZB8gvCkesQQxszQZLilT16jDdcLmWFbh4wGHnULfuvtdz1sG79DvYLexu5EZVMwuqPHnCE0lC2Uv/VJTHmqTRyGV3drN/zFP6ubtfQUkgcR9E4C05TC0CkKUQtXuNzv9oE6aPkrQYvxQZKbhsVxBK8BZQ6K9pn/BKOBU/PinD86pclRVHGU2m+Qb4Ik77IVUh5V/0CW168EdiAMQhdc7bdytYo7cn2pNjxztQhT0CDPYH8vYniR0bEFNcQEbFNwlXz/StyqsT5vu035a5Qo9NQy/kMtn6KxTfGyvinvZzkGkp9T+85HSL6BAaBWYYgmRpgKniML/aN0L3aJPegABovnt1EeC9sFoq8Kc8omZF4XjxNxlolsq1tUWnOAVyaWpth8xz6iS24ixbWyIRvws2rkNaOPF9c6frnIdogK7Oo4bbEPJVa/4aufX+3URG1gKFbUokC29iDVRybkwIvqU5GBtMU18gXM8pRIlc45too3Zh4l3fvpVnM4YJCsyv0wKCuSLjzcqKoAw=
  bucket: evebox-ci.satie.io
  skip_cleanup: true
  region: us-east-1
  local_dir: deploy
  on:
    repo: satie/evebox
    branch: release
  acl: public_read
  upload-dir: release
