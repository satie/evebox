sudo: false
services:
- docker
env:
  global:
  - GOPATH=~/gopath
  - PATH=${GOPATH}/bin:$PATH
  - NODE_VERSION="10.13.0"
  - RUBY_VERSION=2.1.1
  - GO111MODULE=on
  - DOCKER_OWNER=satie
  - DOCKER_IMAGE_NAME=evebox
  - DOCKER_REPO=${DOCKER_OWNER}/${DOCKER_IMAGE_NAME}
  - secure: MIjDS1Jctp/NhAt6lf2SxYEbD3t3226WyvrllW07vz42TvNi7iKVguEvQX7Fk8SXs3LqmefO+CyBiAp/x2v9Gwzs528AK65K6rHk+94KkCSLKQnhJma4NAfzrR+wxjFFttEheoHQeM+zR6Elj6aSvIGFSClUAXTUY3KPw9ORsp4kxS4UPwaR8W645Y51AT2+orF7T2yTO4WCBkEXSo6YsAmXTy3XmtGx0zLPFH7/og91LXsVGyDfyH7I1jLfijNOT+8amMcifbzFsEkc/G8Wq4HJK7SPBU/hMkAsEjLnabnXh5Cex6DcowLKboZqnTWl3NUcrTFCpy5dXvS4l8YqqSf25xX3m2NVmmsE6gXXOq+a/R7dnqiSzEcx2xvUlcJVKHQFXDhSZWJPKekTvWrlYyerE+bfzAlRQOLzlTlOXj4zyRRGwX+OXbVyQ4uqQUKSKLrCAG542+dQObWrhYUz6b5pFBBOpNl47u60R/IwML7CgZS5dhK0H5C9GuIIPpIHTSQ7+jRJIzHohZr7xB6XRsMgbZeC/1gc/cJlZ8a3rMwlkxfT+mDVhrNhfht3eyekssfynlQXddoSSkJNO5Hrl4tZ+5GbjUeKIWlcaKEeseitc9nl1n+f49byX0CwG2KeggaqsMij06I4s1mdahIhgbZ1WtIKZqtnR3C4nOnrtXg= #DOCKER_USER
  - secure: F6n0uS7RtGFV+KWlXv/AlHqyHk1e9PSaI5c7HnQT5m0o2kPj3A6mDN1up/hPzXeYJFfxLScemt/pjpEQbVQTWqKvFCK58sZsPB/a+uuvLtha5G7KNWjI0HpC7ED/UjmSfGZkoq5+OOB5uPQAJb0l/6GDFYUKfS95SLLc7CxUyxOhKXq3uVH4isJK/Bs+ik62WOpIg/Ui+4NBuZx343eHfreD0U/FhekihUrc3jtT0RQAnGtLSJojqppOGqVCDKwLoTFImSRwzhVyuHbdzIISnh784w/pIlBOtmzeMtBNlmbnGwkpZUkv/i4TKTmyPbe5j/f/raY+z5pxn1MPhXB6uftxXuOAugP8TdUVJQcRx/MKeOwsU4sJbaSXxSHGiQZdGpP33qifQqqQ7RN0PzsbdN5w2BsfKVRq1MmR8dCbzB7bX3q++nEQx20kFZqUYxUCN9yszK7weXF68+GUYr+DtrnfcjLw6FcqVNaS1ubF250OSXOYAxBQoj10wgwxcUDJ55CJ7YyNTY/apROxP7c3aNvl/B2zC1IidNsVD8XufHuiYAO1u9li757mLMtUfkCHzYwXPRXMFwwMdWhoXkOwTxVda4lWHWGJ4xiR2i0w4Bjm9nwINQG07gP4uqI5MeiV5EzMNZQbj4XadSkYSibnSwI/PqGVid9WEgE/nsqJMc8= #DOCKER_PASSWORD
matrix:
  allow_failures:
  - os: osx
  include:
  - os: linux
    addons:
      apt:
        packages:
        - rpm
        - gcc-mingw-w64
    language: go
    go: '1.11'
  - os: osx
    osx_image: xcode8.3
    language: go
    go: '1.11'
before_install:
- nvm install ${NODE_VERSION}
- nvm use ${NODE_VERSION}
script:
- |
  make install-deps || exit 1
  make dist || exit 1

  # On Linux, make a Windows release as well.
  if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
    GOOS=windows CC=x86_64-w64-mingw32-gcc make dist || exit 1
  fi

  # Copy just what we want to deploy to S3 into a deploy directory, as
  # the S3 deployment step will copy everything in the directory
  # pointed at.
  mkdir -p deploy
  cp dist/*.zip deploy/

  if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
    rvm install $RUBY_VERSION
    rvm use $RUBY_VERSION
    gem install fpm
    sudo apt-get -y install rpm
    make deb
    make rpm
    cp dist/*.deb deploy/
    cp dist/*.rpm deploy/
  fi
after_success:
  - echo ${DOCKER_USER}
  - docker login -u "${DOCKER_USER}" -p "${DOCKER_PASSWORD}"
  - docker build -t ${DOCKER_REPO}:${TRAVIS_COMMIT} ./docker/release-${TRAVIS_BRANCH}
  - docker tag ${DOCKER_REPO}:${TRAVIS_COMMIT} ${DOCKER_REPO}:${TRAVIS_BRANCH}
  - docker tag ${DOCKER_REPO}:${TRAVIS_COMMIT} ${DOCKER_REPO}:travis-${TRAVIS_BUILD_NUMBER}
  - docker push ${DOCKER_REPO}
deploy:
- provider: s3
  access_key_id:
    secure: kxjAF09t7HDgwn0q/xsvIqpi0VULwYMetHpEXZ56w2pkmq6e3ReHOwpXpbsMHg2FSbkf5Hblb1st9WcdmVpySO/Cj6NKahmZSaD+DA5ckB6e5N/6Y/7qmSXRxw/dFFVbjdRoqZ4WnzPQ4s22AjJGUgvrNk3PtaM/FnG0I+Jb3aVA0VWBvMnP+cBaq7aM7RT6+/TZXdVgT9Y2xMpyjD6kfur7njg1s0023MgiIdGafBH7vdbtr7N/YEDR4Z8oVXC3yZBbAnADn19f6Rl220F1JXsRCY25j55aXBpdbNu9L+W+43rFb+tDl/t7DyalgsZE5oB1pzWjh2uVShJfV+pvGoTL7sgZcpVxqU6dCHCTm9I7Tb6UtJpDECIuiyq/gGOPEbyHuUPZ3E3z9UO960Hnbq7jFUgBg0P/+AF5vzI/DPksNiHMahkmgJtBk/Wbanb28I/gKO4Nf5INn5yUqUXo+eUx1kmuFWBNcVqH/DCV6glCeUwsmS5piMXipemBEwLlSPr9An7exh/2TEcXU62Dcfd/vVWLji6n1/NezYW/Hr8kjWqgFMyp5JbIwza+g05xlAXD2afu1m94PAEyI6u7DN5lbh05PWoKYfNKHmx9Hka0GltAbJs/jsa1rvIjFn+XVE4mQeOHmLRI4pIl3zGpR4FCUCj510fnQaoUR1l6U9U=
  secret_access_key:
    secure: iLGTpFwLHTfDZaR6jlSovWK3S8f+QzPX0Czez57SZAN8CMqqPljSsHSGSavBU4v3YamMhOwCNka1p99L3q9pzr2sEKDYBfsAIB0HMi8820iF4B+6qYpnhOKrSwxs62/+Nujqfqe0Nyn+RVGHdA2yDW6gHNzIe18ZB8gvCkesQQxszQZLilT16jDdcLmWFbh4wGHnULfuvtdz1sG79DvYLexu5EZVMwuqPHnCE0lC2Uv/VJTHmqTRyGV3drN/zFP6ubtfQUkgcR9E4C05TC0CkKUQtXuNzv9oE6aPkrQYvxQZKbhsVxBK8BZQ6K9pn/BKOBU/PinD86pclRVHGU2m+Qb4Ik77IVUh5V/0CW168EdiAMQhdc7bdytYo7cn2pNjxztQhT0CDPYH8vYniR0bEFNcQEbFNwlXz/StyqsT5vu035a5Qo9NQy/kMtn6KxTfGyvinvZzkGkp9T+85HSL6BAaBWYYgmRpgKniML/aN0L3aJPegABovnt1EeC9sFoq8Kc8omZF4XjxNxlolsq1tUWnOAVyaWpth8xz6iS24ixbWyIRvws2rkNaOPF9c6frnIdogK7Oo4bbEPJVa/4aufX+3URG1gKFbUokC29iDVRybkwIvqU5GBtMU18gXM8pRIlc45too3Zh4l3fvpVnM4YJCsyv0wKCuSLjzcqKoAw=
  bucket: evebox-ci.satie.io
  skip_cleanup: true
  region: us-east-1
  local_dir: deploy
  on:
    repo: satie/evebox
    branch: master
  acl: public_read
  upload-dir: master
- provider: s3
  access_key_id:
    secure: kxjAF09t7HDgwn0q/xsvIqpi0VULwYMetHpEXZ56w2pkmq6e3ReHOwpXpbsMHg2FSbkf5Hblb1st9WcdmVpySO/Cj6NKahmZSaD+DA5ckB6e5N/6Y/7qmSXRxw/dFFVbjdRoqZ4WnzPQ4s22AjJGUgvrNk3PtaM/FnG0I+Jb3aVA0VWBvMnP+cBaq7aM7RT6+/TZXdVgT9Y2xMpyjD6kfur7njg1s0023MgiIdGafBH7vdbtr7N/YEDR4Z8oVXC3yZBbAnADn19f6Rl220F1JXsRCY25j55aXBpdbNu9L+W+43rFb+tDl/t7DyalgsZE5oB1pzWjh2uVShJfV+pvGoTL7sgZcpVxqU6dCHCTm9I7Tb6UtJpDECIuiyq/gGOPEbyHuUPZ3E3z9UO960Hnbq7jFUgBg0P/+AF5vzI/DPksNiHMahkmgJtBk/Wbanb28I/gKO4Nf5INn5yUqUXo+eUx1kmuFWBNcVqH/DCV6glCeUwsmS5piMXipemBEwLlSPr9An7exh/2TEcXU62Dcfd/vVWLji6n1/NezYW/Hr8kjWqgFMyp5JbIwza+g05xlAXD2afu1m94PAEyI6u7DN5lbh05PWoKYfNKHmx9Hka0GltAbJs/jsa1rvIjFn+XVE4mQeOHmLRI4pIl3zGpR4FCUCj510fnQaoUR1l6U9U=
  secret_access_key:
    secure: iLGTpFwLHTfDZaR6jlSovWK3S8f+QzPX0Czez57SZAN8CMqqPljSsHSGSavBU4v3YamMhOwCNka1p99L3q9pzr2sEKDYBfsAIB0HMi8820iF4B+6qYpnhOKrSwxs62/+Nujqfqe0Nyn+RVGHdA2yDW6gHNzIe18ZB8gvCkesQQxszQZLilT16jDdcLmWFbh4wGHnULfuvtdz1sG79DvYLexu5EZVMwuqPHnCE0lC2Uv/VJTHmqTRyGV3drN/zFP6ubtfQUkgcR9E4C05TC0CkKUQtXuNzv9oE6aPkrQYvxQZKbhsVxBK8BZQ6K9pn/BKOBU/PinD86pclRVHGU2m+Qb4Ik77IVUh5V/0CW168EdiAMQhdc7bdytYo7cn2pNjxztQhT0CDPYH8vYniR0bEFNcQEbFNwlXz/StyqsT5vu035a5Qo9NQy/kMtn6KxTfGyvinvZzkGkp9T+85HSL6BAaBWYYgmRpgKniML/aN0L3aJPegABovnt1EeC9sFoq8Kc8omZF4XjxNxlolsq1tUWnOAVyaWpth8xz6iS24ixbWyIRvws2rkNaOPF9c6frnIdogK7Oo4bbEPJVa/4aufX+3URG1gKFbUokC29iDVRybkwIvqU5GBtMU18gXM8pRIlc45too3Zh4l3fvpVnM4YJCsyv0wKCuSLjzcqKoAw=
  bucket: evebox-ci.satie.io
  skip_cleanup: true
  region: us-east-1
  local_dir: deploy
  on:
    repo: satie/evebox
    branch: develop
  acl: public_read
  upload-dir: develop
- provider: s3
  access_key_id:
    secure: kxjAF09t7HDgwn0q/xsvIqpi0VULwYMetHpEXZ56w2pkmq6e3ReHOwpXpbsMHg2FSbkf5Hblb1st9WcdmVpySO/Cj6NKahmZSaD+DA5ckB6e5N/6Y/7qmSXRxw/dFFVbjdRoqZ4WnzPQ4s22AjJGUgvrNk3PtaM/FnG0I+Jb3aVA0VWBvMnP+cBaq7aM7RT6+/TZXdVgT9Y2xMpyjD6kfur7njg1s0023MgiIdGafBH7vdbtr7N/YEDR4Z8oVXC3yZBbAnADn19f6Rl220F1JXsRCY25j55aXBpdbNu9L+W+43rFb+tDl/t7DyalgsZE5oB1pzWjh2uVShJfV+pvGoTL7sgZcpVxqU6dCHCTm9I7Tb6UtJpDECIuiyq/gGOPEbyHuUPZ3E3z9UO960Hnbq7jFUgBg0P/+AF5vzI/DPksNiHMahkmgJtBk/Wbanb28I/gKO4Nf5INn5yUqUXo+eUx1kmuFWBNcVqH/DCV6glCeUwsmS5piMXipemBEwLlSPr9An7exh/2TEcXU62Dcfd/vVWLji6n1/NezYW/Hr8kjWqgFMyp5JbIwza+g05xlAXD2afu1m94PAEyI6u7DN5lbh05PWoKYfNKHmx9Hka0GltAbJs/jsa1rvIjFn+XVE4mQeOHmLRI4pIl3zGpR4FCUCj510fnQaoUR1l6U9U=
  secret_access_key:
    secure: iLGTpFwLHTfDZaR6jlSovWK3S8f+QzPX0Czez57SZAN8CMqqPljSsHSGSavBU4v3YamMhOwCNka1p99L3q9pzr2sEKDYBfsAIB0HMi8820iF4B+6qYpnhOKrSwxs62/+Nujqfqe0Nyn+RVGHdA2yDW6gHNzIe18ZB8gvCkesQQxszQZLilT16jDdcLmWFbh4wGHnULfuvtdz1sG79DvYLexu5EZVMwuqPHnCE0lC2Uv/VJTHmqTRyGV3drN/zFP6ubtfQUkgcR9E4C05TC0CkKUQtXuNzv9oE6aPkrQYvxQZKbhsVxBK8BZQ6K9pn/BKOBU/PinD86pclRVHGU2m+Qb4Ik77IVUh5V/0CW168EdiAMQhdc7bdytYo7cn2pNjxztQhT0CDPYH8vYniR0bEFNcQEbFNwlXz/StyqsT5vu035a5Qo9NQy/kMtn6KxTfGyvinvZzkGkp9T+85HSL6BAaBWYYgmRpgKniML/aN0L3aJPegABovnt1EeC9sFoq8Kc8omZF4XjxNxlolsq1tUWnOAVyaWpth8xz6iS24ixbWyIRvws2rkNaOPF9c6frnIdogK7Oo4bbEPJVa/4aufX+3URG1gKFbUokC29iDVRybkwIvqU5GBtMU18gXM8pRIlc45too3Zh4l3fvpVnM4YJCsyv0wKCuSLjzcqKoAw=
  bucket: evebox-ci.satie.io
  skip_cleanup: true
  region: us-east-1
  local_dir: deploy
  on:
    repo: satie/evebox
    branch: release-staging
  acl: public_read
  upload-dir: release-staging
- provider: s3
  access_key_id:
    secure: kxjAF09t7HDgwn0q/xsvIqpi0VULwYMetHpEXZ56w2pkmq6e3ReHOwpXpbsMHg2FSbkf5Hblb1st9WcdmVpySO/Cj6NKahmZSaD+DA5ckB6e5N/6Y/7qmSXRxw/dFFVbjdRoqZ4WnzPQ4s22AjJGUgvrNk3PtaM/FnG0I+Jb3aVA0VWBvMnP+cBaq7aM7RT6+/TZXdVgT9Y2xMpyjD6kfur7njg1s0023MgiIdGafBH7vdbtr7N/YEDR4Z8oVXC3yZBbAnADn19f6Rl220F1JXsRCY25j55aXBpdbNu9L+W+43rFb+tDl/t7DyalgsZE5oB1pzWjh2uVShJfV+pvGoTL7sgZcpVxqU6dCHCTm9I7Tb6UtJpDECIuiyq/gGOPEbyHuUPZ3E3z9UO960Hnbq7jFUgBg0P/+AF5vzI/DPksNiHMahkmgJtBk/Wbanb28I/gKO4Nf5INn5yUqUXo+eUx1kmuFWBNcVqH/DCV6glCeUwsmS5piMXipemBEwLlSPr9An7exh/2TEcXU62Dcfd/vVWLji6n1/NezYW/Hr8kjWqgFMyp5JbIwza+g05xlAXD2afu1m94PAEyI6u7DN5lbh05PWoKYfNKHmx9Hka0GltAbJs/jsa1rvIjFn+XVE4mQeOHmLRI4pIl3zGpR4FCUCj510fnQaoUR1l6U9U=
  secret_access_key:
    secure: iLGTpFwLHTfDZaR6jlSovWK3S8f+QzPX0Czez57SZAN8CMqqPljSsHSGSavBU4v3YamMhOwCNka1p99L3q9pzr2sEKDYBfsAIB0HMi8820iF4B+6qYpnhOKrSwxs62/+Nujqfqe0Nyn+RVGHdA2yDW6gHNzIe18ZB8gvCkesQQxszQZLilT16jDdcLmWFbh4wGHnULfuvtdz1sG79DvYLexu5EZVMwuqPHnCE0lC2Uv/VJTHmqTRyGV3drN/zFP6ubtfQUkgcR9E4C05TC0CkKUQtXuNzv9oE6aPkrQYvxQZKbhsVxBK8BZQ6K9pn/BKOBU/PinD86pclRVHGU2m+Qb4Ik77IVUh5V/0CW168EdiAMQhdc7bdytYo7cn2pNjxztQhT0CDPYH8vYniR0bEFNcQEbFNwlXz/StyqsT5vu035a5Qo9NQy/kMtn6KxTfGyvinvZzkGkp9T+85HSL6BAaBWYYgmRpgKniML/aN0L3aJPegABovnt1EeC9sFoq8Kc8omZF4XjxNxlolsq1tUWnOAVyaWpth8xz6iS24ixbWyIRvws2rkNaOPF9c6frnIdogK7Oo4bbEPJVa/4aufX+3URG1gKFbUokC29iDVRybkwIvqU5GBtMU18gXM8pRIlc45too3Zh4l3fvpVnM4YJCsyv0wKCuSLjzcqKoAw=
  bucket: evebox-ci.satie.io
  skip_cleanup: true
  region: us-east-1
  local_dir: deploy
  on:
    repo: satie/evebox
    branch: release
  acl: public_read
  upload-dir: release
# - provider: script
#   script: docker login -u "$DOCKER_USER" -p "$DOCKER_PASSWORD" &&
#     docker build -t $DOCKER_REPO:$TRAVIS_COMMIT ./docker/release-${TRAVIS_BRANCH}
#     && docker tag $DOCKER_REPO:$TRAVIS_COMMIT $DOCKER_REPO:$TRAVIS_BRANCH && docker
#     tag $DOCKER_REPO:$TRAVIS_COMMIT $DOCKER_REPO:travis-$TRAVIS_BUILD_NUMBER && docker
#     push $DOCKER_REPO
#   on:
#     repo: satie/evebox
#     branch: master
